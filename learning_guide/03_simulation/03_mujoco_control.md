# 3.3 MuJoCo í‚¤ë³´ë“œ ì œì–´

XLeRobotì˜ MuJoCo ì‹œë®¬ë ˆì´ì…˜ì—ì„œ í‚¤ë³´ë“œë¡œ ë¡œë´‡ì„ ì§ì ‘ ì œì–´í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤.

## ëª©ì°¨
- [ì œì–´ ê°œìš”](#ì œì–´-ê°œìš”)
- [í‚¤ë³´ë“œ ë§¤í•‘](#í‚¤ë³´ë“œ-ë§¤í•‘)
- [ì œì–´ ì‹œì‘í•˜ê¸°](#ì œì–´-ì‹œì‘í•˜ê¸°)
- [XLeRobotController ë¶„ì„](#xlerobot controller-ë¶„ì„)
- [ê³ ê¸‰ ì œì–´ ê¸°ë²•](#ê³ ê¸‰-ì œì–´-ê¸°ë²•)
- [ì‹¤ìŠµ ê³¼ì œ](#ì‹¤ìŠµ-ê³¼ì œ)

---

## ì œì–´ ê°œìš”

### ì œì–´ êµ¬ì¡°

XLeRobotì€ **3ê°€ì§€ ì£¼ìš” ë¶€ë¶„**ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         XLeRobot ì œì–´ êµ¬ì¡°           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  1ï¸âƒ£ ë² ì´ìŠ¤ (Chassis)                â”‚
â”‚     - 3ììœ ë„ ì „ë°©í–¥ ì´ë™            â”‚
â”‚     - Home/End/Delete/PgDn/Ins/PgUp â”‚
â”‚                                     â”‚
â”‚  2ï¸âƒ£ ì™¼íŒ” (Left Arm - SO-100)        â”‚
â”‚     - 6ììœ ë„ ê´€ì ˆ (ì‹¤ì œë¡  3ê°œë§Œ)    â”‚
â”‚     - Q/A, W/S, E/D                 â”‚
â”‚                                     â”‚
â”‚  3ï¸âƒ£ ì˜¤ë¥¸íŒ” (Right Arm - SO-100)     â”‚
â”‚     - 6ììœ ë„ ê´€ì ˆ (ì‹¤ì œë¡  3ê°œë§Œ)    â”‚
â”‚     - U/J, I/K, O/L                 â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì œì–´ ë°©ì‹

- **ì¦ë¶„ ì œì–´ (Incremental Control)**: í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì¡°ê¸ˆì”© ì›€ì§ì„
- **ì‹¤ì‹œê°„ í”¼ë“œë°±**: í™”ë©´ì— í˜„ì¬ ìƒíƒœ í‘œì‹œ
- **ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„**: 60Hzë¡œ ì—…ë°ì´íŠ¸

---

## í‚¤ë³´ë“œ ë§¤í•‘

### ğŸ“ ë² ì´ìŠ¤(ì„€ì‹œ) ì œì–´ - ì „ë°©í–¥ ì´ë™

| í‚¤ | ë™ì‘ | ë°©í–¥ | ì„¤ëª… |
|----|------|------|------|
| **`Home`** | ì „ì§„ | +X | ë¡œë´‡ ì•ìœ¼ë¡œ ì´ë™ |
| **`End`** | í›„ì§„ | -X | ë¡œë´‡ ë’¤ë¡œ ì´ë™ |
| **`Delete`** | ì¢Œì´ë™ | +Y | ë¡œë´‡ ì™¼ìª½ìœ¼ë¡œ ì´ë™ |
| **`Page Down`** | ìš°ì´ë™ | -Y | ë¡œë´‡ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ |
| **`Insert`** | ì¢ŒíšŒì „ | +Î¸ (CCW) | ì œìë¦¬ì—ì„œ ë°˜ì‹œê³„ íšŒì „ |
| **`Page Up`** | ìš°íšŒì „ | -Î¸ (CW) | ì œìë¦¬ì—ì„œ ì‹œê³„ íšŒì „ |

#### ì „ë°©í–¥ ì´ë™ ì›ë¦¬

```
        ì „ì§„ (Home)
           â†‘
           â”‚
ì¢Œì´ë™ â†â”€â”€â”€â”¼â”€â”€â”€â†’ ìš°ì´ë™
(Delete)   â”‚   (Page Down)
           â”‚
           â†“
        í›„ì§„ (End)

íšŒì „: Insert(â†¶) / Page Up(â†·)
```

**ì˜´ë‹ˆ íœ  (Omni-directional Wheel)**:
- 3ê°œì˜ ë©”ì¹´ë„˜ íœ ë¡œ ì „ë°©í–¥ ì´ë™ ê°€ëŠ¥
- ê°ë„ ì œì•½ ì—†ì´ ììœ ë¡­ê²Œ ì´ë™
- ì¢ì€ ê³µê°„ì—ì„œë„ ê¸°ë™ì„± ìš°ìˆ˜

---

### ğŸ¦¾ ì™¼íŒ” ì œì–´ (Q/W/E - A/S/D)

| í‚¤ ìŒ | ê´€ì ˆ | ì¦ê°€ (+) | ê°ì†Œ (-) | ìŠ¤í… í¬ê¸° |
|-------|------|----------|----------|-----------|
| **Q / A** | Joint 1 | Q | A | 0.005 rad |
| **W / S** | Joint 2 | W | S | 0.005 rad |
| **E / D** | Joint 3 | E | D | 0.005 rad |

#### ê´€ì ˆ ë²ˆí˜¸ ë§¤í•‘

```python
# qCmd ë°°ì—´ ì¸ë±ìŠ¤
qCmd[3]  â†’ ì™¼íŒ” ê´€ì ˆ 1 (ì–´ê¹¨ íšŒì „)
qCmd[4]  â†’ ì™¼íŒ” ê´€ì ˆ 2 (ì–´ê¹¨ ìƒí•˜)
qCmd[5]  â†’ ì™¼íŒ” ê´€ì ˆ 3 (íŒ”ê¿ˆì¹˜)
qCmd[6:9] â†’ ì™¼íŒ” ê´€ì ˆ 4-6 (í˜„ì¬ ë¯¸ì‚¬ìš©, í•­ìƒ 0)
```

#### ì™¼íŒ” í‚¤ ë ˆì´ì•„ì›ƒ (QWERTY í‚¤ë³´ë“œ)

```
  Q   W   E     â† ê´€ì ˆ ì¦ê°€ (+)
  A   S   D     â† ê´€ì ˆ ê°ì†Œ (-)
  â†‘   â†‘   â†‘
  1   2   3     â† ê´€ì ˆ ë²ˆí˜¸
```

---

### ğŸ¦¾ ì˜¤ë¥¸íŒ” ì œì–´ (U/I/O - J/K/L)

| í‚¤ ìŒ | ê´€ì ˆ | ì¦ê°€ (+) | ê°ì†Œ (-) | ìŠ¤í… í¬ê¸° |
|-------|------|----------|----------|-----------|
| **U / J** | Joint 1 | U | J | 0.005 rad |
| **I / K** | Joint 2 | I | K | 0.005 rad |
| **O / L** | Joint 3 | O | L | 0.005 rad |

#### ê´€ì ˆ ë²ˆí˜¸ ë§¤í•‘

```python
# qCmd ë°°ì—´ ì¸ë±ìŠ¤
qCmd[9]   â†’ ì˜¤ë¥¸íŒ” ê´€ì ˆ 1 (ì–´ê¹¨ íšŒì „)
qCmd[10]  â†’ ì˜¤ë¥¸íŒ” ê´€ì ˆ 2 (ì–´ê¹¨ ìƒí•˜)
qCmd[11]  â†’ ì˜¤ë¥¸íŒ” ê´€ì ˆ 3 (íŒ”ê¿ˆì¹˜)
qCmd[12:15] â†’ ì˜¤ë¥¸íŒ” ê´€ì ˆ 4-6 (í˜„ì¬ ë¯¸ì‚¬ìš©, í•­ìƒ 0)
```

#### ì˜¤ë¥¸íŒ” í‚¤ ë ˆì´ì•„ì›ƒ

```
  U   I   O     â† ê´€ì ˆ ì¦ê°€ (+)
  J   K   L     â† ê´€ì ˆ ê°ì†Œ (-)
  â†‘   â†‘   â†‘
  1   2   3     â† ê´€ì ˆ ë²ˆí˜¸
```

---

## ì œì–´ ì‹œì‘í•˜ê¸°

### 1ë‹¨ê³„: í”„ë¡œê·¸ë¨ ì‹¤í–‰

```bash
# MuJoCo ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd ~/XLeRobot/simulation/mujoco/

# ê°€ìƒ í™˜ê²½ í™œì„±í™”
source .venv/bin/activate

# ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
python xlerobot_mujoco.py
```

**ì˜ˆìƒ ì¶œë ¥**:
```
Starting XLeRobot keyboard Controller...
```

3D ë·°ì–´ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤.

---

### 2ë‹¨ê³„: ë² ì´ìŠ¤ ì œì–´ ì‹¤ìŠµ

> âš ï¸ **ì¤‘ìš”**: 3D ë·°ì–´ ì°½ì„ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•´ì„œ í™œì„±í™”!

#### ì‹¤ìŠµ 1: ì‚¬ê°í˜• ê·¸ë¦¬ê¸°

```
ëª©í‘œ: ë¡œë´‡ì„ ì •ì‚¬ê°í˜• ê²½ë¡œë¡œ ì´ë™
```

**ì ˆì°¨**:
1. **`Home`** í‚¤ë¥¼ 5ì´ˆê°„ ì—°ì† ëˆ„ë¦„ (ì „ì§„)
2. **`Delete`** í‚¤ë¥¼ 5ì´ˆê°„ ëˆ„ë¦„ (ì¢Œì´ë™)
3. **`End`** í‚¤ë¥¼ 5ì´ˆê°„ ëˆ„ë¦„ (í›„ì§„)
4. **`Page Down`** í‚¤ë¥¼ 5ì´ˆê°„ ëˆ„ë¦„ (ìš°ì´ë™)
5. ì‹œì‘ ìœ„ì¹˜ë¡œ ë³µê·€ í™•ì¸

**í™”ë©´ í•˜ë‹¨ í”¼ë“œë°±**:
```
command: Chassis Vel: [0.50, 0.00, 0.00]   â† Home í‚¤ ëˆŒë €ì„ ë•Œ
feedback: Chassis Vel: [0.48, 0.01, 0.00]  â† ì‹¤ì œ ì†ë„
```

#### ì‹¤ìŠµ 2: ì œìë¦¬ íšŒì „

```
ëª©í‘œ: 360ë„ íšŒì „
```

**ì ˆì°¨**:
1. **`Insert`** í‚¤ë¥¼ 10ì´ˆê°„ ëˆ„ë¦„ (ë°˜ì‹œê³„ íšŒì „)
2. ë¡œë´‡ì´ í•œ ë°”í€´ ëŒì•˜ëŠ”ì§€ í™•ì¸
3. **`Page Up`** í‚¤ë¡œ ë°˜ëŒ€ ë°©í–¥ íšŒì „

**ê´€ì°° í¬ì¸íŠ¸**:
- ë² ì´ìŠ¤ëŠ” íšŒì „í•˜ì§€ë§Œ íŒ”ì€ ê³ ì •
- í™”ë©´ì—ì„œ `Chassis Vel: [0.00, 0.00, 0.52]` í™•ì¸

---

### 3ë‹¨ê³„: ì™¼íŒ” ì œì–´ ì‹¤ìŠµ

#### ì‹¤ìŠµ 3: ê´€ì ˆ 1 í…ŒìŠ¤íŠ¸ (Q/A)

```
ëª©í‘œ: ì–´ê¹¨ íšŒì „ ê´€ì ˆ ì´í•´
```

**ì ˆì°¨**:
1. 3D ì°½ì„ ì™¼ìª½ íŒ”ì´ ì˜ ë³´ì´ë„ë¡ íšŒì „ (ë§ˆìš°ìŠ¤ ë“œë˜ê·¸)
2. **`Q`** í‚¤ë¥¼ 5íšŒ ì§§ê²Œ ëˆ„ë¦„ (íƒ­ íƒ­ íƒ­...)
3. ì™¼íŒ”ì´ ì•ìª½ìœ¼ë¡œ íšŒì „í•˜ëŠ”ì§€ ê´€ì°°
4. **`A`** í‚¤ë¡œ ì›ë˜ ìœ„ì¹˜ë¡œ ë³µê·€

**í™”ë©´ í”¼ë“œë°±**:
```
Left Arm: [0.03, 0.00, 0.00]   â† ê´€ì ˆ 1ë§Œ ë³€í™”
```

#### ì‹¤ìŠµ 4: ê´€ì ˆ 2 í…ŒìŠ¤íŠ¸ (W/S)

```
ëª©í‘œ: ì–´ê¹¨ ìƒí•˜ ê´€ì ˆ ì´í•´
```

**ì ˆì°¨**:
1. **`W`** í‚¤ë¥¼ ëˆ„ë¦„ â†’ íŒ”ì´ ìœ„ë¡œ ì˜¬ë¼ê°
2. **`S`** í‚¤ë¥¼ ëˆ„ë¦„ â†’ íŒ”ì´ ì•„ë˜ë¡œ ë‚´ë ¤ê°
3. ê° ê´€ì ˆì˜ ì›€ì§ì„ì„ ì²œì²œíˆ ê´€ì°°

#### ì‹¤ìŠµ 5: ê´€ì ˆ 3 í…ŒìŠ¤íŠ¸ (E/D)

```
ëª©í‘œ: íŒ”ê¿ˆì¹˜ ê´€ì ˆ ì´í•´
```

**ì ˆì°¨**:
1. **`E`** í‚¤ë¥¼ ëˆ„ë¦„ â†’ íŒ”ê¿ˆì¹˜ê°€ êµ½í˜€ì§
2. **`D`** í‚¤ë¥¼ ëˆ„ë¦„ â†’ íŒ”ê¿ˆì¹˜ê°€ í´ì§
3. íŒ”ì´ ì ‘í˜”ë‹¤ í´ì¡Œë‹¤ í•˜ëŠ” ë™ì‘ í™•ì¸

---

### 4ë‹¨ê³„: ì˜¤ë¥¸íŒ” ì œì–´ ì‹¤ìŠµ

#### ì‹¤ìŠµ 6: ì–‘íŒ” ë™ì‹œ ì œì–´

```
ëª©í‘œ: ì–‘íŒ”ì„ ë™ì‹œì— ì›€ì§ì—¬ ëŒ€ì¹­ ë™ì‘ ë§Œë“¤ê¸°
```

**ì ˆì°¨**:
1. **`Q`** + **`U`** ë™ì‹œ ëˆ„ë¦„ (ì–‘ìª½ ê´€ì ˆ 1 ì¦ê°€)
2. ì–‘íŒ”ì´ ëŒ€ì¹­ìœ¼ë¡œ ì›€ì§ì´ëŠ”ì§€ í™•ì¸
3. **`A`** + **`J`** ë¡œ ë³µê·€

**í™”ë©´ í”¼ë“œë°±**:
```
Left Arm:  [0.03, 0.00, 0.00]
Right Arm: [0.03, 0.00, 0.00]   â† ëŒ€ì¹­!
```

---

## XLeRobotController ë¶„ì„

### í´ë˜ìŠ¤ êµ¬ì¡°

```python
class XLeRobotController:
    def __init__(self, mjcf_path):
        """ì´ˆê¸°í™”: ëª¨ë¸ ë¡œë“œ, ë·°ì–´ ìƒì„±, ë³€ìˆ˜ ì´ˆê¸°í™”"""
        
    def update_feedback(self):
        """ì„¼ì„œì—ì„œ í”¼ë“œë°± ì½ê¸° (í˜„ì¬ ì†ë„, ìœ„ì¹˜)"""
        
    def update_keyboards(self):
        """í‚¤ë³´ë“œ ìƒíƒœ ì½ê¸° (GLFW ì´ë²¤íŠ¸)"""
        
    def update_reference(self):
        """í‚¤ë³´ë“œ ì…ë ¥ â†’ ì œì–´ ëª…ë ¹ ë³€í™˜"""
        
    def update_control(self):
        """ì œì–´ ëª…ë ¹ â†’ MuJoCo actuator ì „ë‹¬"""
        
    def render_ui(self):
        """í™”ë©´ ë Œë”ë§ ë° UI ì˜¤ë²„ë ˆì´"""
        
    def run(self):
        """ë©”ì¸ ë£¨í”„ (60Hz)"""
        
    def cleanup(self):
        """ì¢…ë£Œ ì²˜ë¦¬"""
```

---

### í•µì‹¬ ì½”ë“œ ë¶„ì„

#### 1. í‚¤ë³´ë“œ ìƒíƒœ ë”•ì…”ë„ˆë¦¬

```python
# __init__ ë©”ì„œë“œ ë‚´ë¶€
self.key_states = {
    "home": False,      # ì „ì§„
    "end": False,       # í›„ì§„
    "delete": False,    # ì¢Œì´ë™
    "page_down": False, # ìš°ì´ë™
    "insert": False,    # ì¢ŒíšŒì „
    "page_up": False,   # ìš°íšŒì „
    "q": False, "a": False,  # ì™¼íŒ” ê´€ì ˆ 1
    "w": False, "s": False,  # ì™¼íŒ” ê´€ì ˆ 2
    "e": False, "d": False,  # ì™¼íŒ” ê´€ì ˆ 3
    "u": False, "j": False,  # ì˜¤ë¥¸íŒ” ê´€ì ˆ 1
    "i": False, "k": False,  # ì˜¤ë¥¸íŒ” ê´€ì ˆ 2
    "o": False, "l": False,  # ì˜¤ë¥¸íŒ” ê´€ì ˆ 3
}
```

**ë™ì‘ ì›ë¦¬**:
- GLFW ì°½ì—ì„œ í‚¤ ì´ë²¤íŠ¸ ê°ì§€
- `True`: í‚¤ê°€ ëˆŒë¦¼, `False`: í‚¤ê°€ ë–¼ì–´ì§
- ë§¤ í”„ë ˆì„ë§ˆë‹¤ ìƒíƒœ í™•ì¸

---

#### 2. í‚¤ë³´ë“œ ì…ë ¥ ì½ê¸°

```python
def update_keyboards(self):
    glfw.poll_events()  # GLFW ì´ë²¤íŠ¸ ì²˜ë¦¬
    
    # ê° í‚¤ì˜ ìƒíƒœ í™•ì¸
    self.key_states["home"] = glfw.get_key(
        self.viewer.window, glfw.KEY_HOME
    ) == glfw.PRESS
    
    self.key_states["q"] = glfw.get_key(
        self.viewer.window, glfw.KEY_Q
    ) == glfw.PRESS
    
    # ... ë‚˜ë¨¸ì§€ í‚¤ë“¤ë„ ë™ì¼
```

**GLFW í‚¤ ì½”ë“œ**:
- `glfw.KEY_HOME`, `glfw.KEY_END`, `glfw.KEY_DELETE` ë“±
- `glfw.PRESS`: í‚¤ê°€ ëˆŒë¦¼
- `glfw.RELEASE`: í‚¤ê°€ ë–¼ì–´ì§

---

#### 3. ë² ì´ìŠ¤ ì œì–´ ëª…ë ¹ ê³„ì‚°

```python
def update_reference(self):
    # í˜„ì¬ ë¡œë´‡ ë°©í–¥ (yaw angle)
    yaw = self.qFb[2]
    
    # íšŒì „ ë³€í™˜ í–‰ë ¬
    rotmz = np.array([
        [np.cos(yaw), np.sin(yaw), 0],
        [-np.sin(yaw), np.cos(yaw), 0],
        [0, 0, 1],
    ])
    
    # ëª©í‘œ ì†ë„ ê³„ì‚°
    self.chassis_ref_vel = np.zeros(3)
    if self.key_states["home"]:
        self.chassis_ref_vel[0] = self.abs_vel[0]  # +x
    elif self.key_states["end"]:
        self.chassis_ref_vel[0] = -self.abs_vel[0]  # -x
    
    if self.key_states["delete"]:
        self.chassis_ref_vel[1] = self.abs_vel[1]  # +y
    elif self.key_states["page_down"]:
        self.chassis_ref_vel[1] = -self.abs_vel[1]  # -y
    
    if self.key_states["insert"]:
        self.chassis_ref_vel[2] = self.abs_vel[2]  # +Î¸ (CCW)
    elif self.key_states["page_up"]:
        self.chassis_ref_vel[2] = -self.abs_vel[2]  # -Î¸ (CW)
    
    # PD ì œì–´ë¡œ ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„
    k_p = 10
    k_p_rot = 100
    self.qdCmd[0] = ... # ë³µì¡í•œ ê³„ì‚° (ìƒëµ)
```

**ì œì–´ ë¡œì§**:
1. **í‚¤ ìƒíƒœ í™•ì¸**: `if self.key_states["home"]:`
2. **ëª©í‘œ ì†ë„ ì„¤ì •**: `chassis_ref_vel[0] = 0.5 m/s`
3. **PD ì œì–´**: ëª©í‘œ ì†ë„ì™€ ì‹¤ì œ ì†ë„ ì°¨ì´ë¥¼ ì¤„ì„
4. **ì˜´ë‹ˆíœ  ë³€í™˜**: 3D ì†ë„ â†’ 3ê°œ íœ  ì†ë„

---

#### 4. íŒ” ì œì–´ ëª…ë ¹ ê³„ì‚°

```python
def update_reference(self):
    # ... ë² ì´ìŠ¤ ì œì–´ ì´í›„
    
    arm_step = 0.005  # ë¼ë””ì•ˆ ë‹¨ìœ„ ì¦ë¶„
    
    # ì™¼íŒ” ê´€ì ˆ 1 (Q/A)
    if self.key_states["q"]:
        self.qCmd[3] += arm_step   # +0.005 rad
    elif self.key_states["a"]:
        self.qCmd[3] -= arm_step   # -0.005 rad
    
    # ì™¼íŒ” ê´€ì ˆ 2 (W/S)
    if self.key_states["w"]:
        self.qCmd[4] += arm_step
    elif self.key_states["s"]:
        self.qCmd[4] -= arm_step
    
    # ì™¼íŒ” ê´€ì ˆ 3 (E/D)
    if self.key_states["e"]:
        self.qCmd[5] += arm_step
    elif self.key_states["d"]:
        self.qCmd[5] -= arm_step
    
    # ì˜¤ë¥¸íŒ”ë„ ë™ì¼ íŒ¨í„´ (U/J, I/K, O/L)
    # ... (ì½”ë“œ ìƒëµ)
    
    # ë¯¸ì‚¬ìš© ê´€ì ˆì€ 0ìœ¼ë¡œ ê³ ì •
    self.qCmd[6:9] = 0.0    # ì™¼íŒ” ê´€ì ˆ 4-6
    self.qCmd[12:15] = 0.0  # ì˜¤ë¥¸íŒ” ê´€ì ˆ 4-6
```

**ì œì–´ ë°©ì‹**:
- **ìœ„ì¹˜ ì œì–´**: í˜„ì¬ ê´€ì ˆ ê°ë„ì— `arm_step` ë”í•˜ê±°ë‚˜ ë¹¼ê¸°
- **ì¦ë¶„ ì œì–´**: ì ˆëŒ€ ìœ„ì¹˜ê°€ ì•„ë‹Œ ìƒëŒ€ ì¦ë¶„
- **í´ë¦¬í•‘ ì—†ìŒ**: ê´€ì ˆ í•œê³„ëŠ” MuJoCoê°€ ìë™ ì²˜ë¦¬

---

#### 5. MuJoCo actuatorì— ëª…ë ¹ ì „ë‹¬

```python
def update_control(self):
    # ë² ì´ìŠ¤ ì†ë„ ëª…ë ¹ì— ê²Œì¸ ì ìš©
    self.qdCmd[0:3] = self.kp * self.qdCmd[0:3]
    
    # MuJoCo data.ctrlì— ê¸°ë¡
    self.data.ctrl[:3] = self.qdCmd[:3]    # ë² ì´ìŠ¤ (x, y, Î¸)
    self.data.ctrl[3:] = self.qCmd[3:]     # íŒ” ê´€ì ˆë“¤
```

**`data.ctrl` ë°°ì—´ êµ¬ì¡°**:
```python
# ì¸ë±ìŠ¤: ì˜ë¯¸
0-2:   ë² ì´ìŠ¤ ì†ë„ (vx, vy, Ï‰z)
3-8:   ì™¼íŒ” 6ê´€ì ˆ ìœ„ì¹˜
9-14:  ì˜¤ë¥¸íŒ” 6ê´€ì ˆ ìœ„ì¹˜
15-17: ì˜´ë‹ˆíœ  3ê°œ ì†ë„ (ìë™ ê³„ì‚°ë¨)
```

---

#### 6. ë©”ì¸ ë£¨í”„ (60Hz)

```python
def run(self):
    print("Starting XLeRobot keyboard Controller...")
    
    while self.viewer.is_alive:  # ì°½ì´ ì—´ë ¤ìˆëŠ” ë™ì•ˆ
        self.update_feedback()    # 1. ì„¼ì„œ ì½ê¸°
        self.update_keyboards()   # 2. í‚¤ë³´ë“œ ì½ê¸°
        self.update_reference()   # 3. ì œì–´ ëª…ë ¹ ê³„ì‚°
        self.update_control()     # 4. actuatorì— ì „ë‹¬
        
        mujoco.mj_step(self.model, self.data)  # 5. ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜
        self.render_ui()          # 6. í™”ë©´ ë Œë”ë§
        
        time.sleep(0.002)  # 7. 2ms ëŒ€ê¸° (â†’ ~500Hz)
    
    self.cleanup()
```

**ì‹¤í–‰ íë¦„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. update_feedback()     â”‚  ì„¼ì„œ ë°ì´í„° ì½ê¸°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. update_keyboards()    â”‚  Q í‚¤ ëˆŒë¦¼ ê°ì§€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. update_reference()    â”‚  qCmd[3] += 0.005
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. update_control()      â”‚  data.ctrl[3] = qCmd[3]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. mj_step()             â”‚  ë¬¼ë¦¬ ê³„ì‚° (ì¶©ëŒ, ì¤‘ë ¥)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. render_ui()           â”‚  í™”ë©´ ì—…ë°ì´íŠ¸ (60Hz)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. sleep(0.002)          â”‚  2ms ëŒ€ê¸°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    ë£¨í”„ ë°˜ë³µ (500Hz)
```

**ì£¼íŒŒìˆ˜ ì°¨ì´**:
- **ì œì–´ ë£¨í”„**: ~500Hz (sleep 0.002ì´ˆ)
- **ë Œë”ë§**: 60Hz (render_intervalë¡œ ì œí•œ)
- **ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜**: 500Hz (ë§¤ ë£¨í”„ë§ˆë‹¤)

---

## ê³ ê¸‰ ì œì–´ ê¸°ë²•

### 1. ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„ (Smooth Control)

í˜„ì¬ ì½”ë“œëŠ” í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ì†ë„ ë³€í™” â†’ ëšëš ëŠê¹€

**ê°œì„ ì•ˆ: ê°€ì†ë„ ì œí•œ**

```python
# update_reference() ë©”ì„œë“œ ìˆ˜ì •
max_accel = 0.1  # m/s^2

# ëª©í‘œ ì†ë„ì™€ í˜„ì¬ ì†ë„ ì°¨ì´ ê³„ì‚°
vel_error = self.chassis_ref_vel[0] - chassis_vel[0]

# ê°€ì†ë„ ì œí•œ ì ìš©
if abs(vel_error) > max_accel * dt:
    vel_change = max_accel * dt * np.sign(vel_error)
else:
    vel_change = vel_error

self.qdCmd[0] += vel_change
```

---

### 2. ê´€ì ˆ í•œê³„ í™•ì¸

í˜„ì¬ëŠ” MuJoCoê°€ ìë™ìœ¼ë¡œ ê´€ì ˆ í•œê³„ë¥¼ ì²˜ë¦¬í•˜ì§€ë§Œ, ì§ì ‘ ì²´í¬ë„ ê°€ëŠ¥:

```python
# xlerobot.xmlì—ì„œ ê´€ì ˆ í•œê³„ í™•ì¸
# <joint name="left_arm_joint1" range="-3.14 3.14"/>

# update_reference()ì—ì„œ í´ë¦¬í•‘
joint_limits = {
    3: (-3.14, 3.14),  # ì™¼íŒ” ê´€ì ˆ 1
    4: (-1.57, 1.57),  # ì™¼íŒ” ê´€ì ˆ 2
    # ... ë‚˜ë¨¸ì§€ ê´€ì ˆ
}

for joint_idx, (min_val, max_val) in joint_limits.items():
    self.qCmd[joint_idx] = np.clip(
        self.qCmd[joint_idx], min_val, max_val
    )
```

---

### 3. í™”ë©´ì— í‚¤ ìƒíƒœ í‘œì‹œ

```python
def render_ui(self):
    # ê¸°ì¡´ ì½”ë“œì— ì¶”ê°€
    active_keys = [k for k, v in self.key_states.items() if v]
    
    self.viewer._overlay[mujoco.mjtGridPos.mjGRID_TOPRIGHT] = [
        f"Active Keys: {', '.join(active_keys) if active_keys else 'None'}",
        "",
    ]
```

**ì˜ˆìƒ í™”ë©´**:
```
Active Keys: q, home     â† ë™ì‹œ ì…ë ¥ í™•ì¸
```

---

### 4. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì¶”ê°€

```python
# update_keyboards()ì—ì„œ íŠ¹ìˆ˜ í‚¤ ì¶”ê°€
self.key_states["r"] = glfw.get_key(
    self.viewer.window, glfw.KEY_R
) == glfw.PRESS

# update_reference()ì—ì„œ ë¦¬ì…‹ ê¸°ëŠ¥
if self.key_states["r"]:
    # ëª¨ë“  ê´€ì ˆì„ ì´ˆê¸° ìœ„ì¹˜ë¡œ
    self.qCmd[:] = self.initial_qCmd.copy()
    print("Position reset!")
```

---

## ì‹¤ìŠµ ê³¼ì œ

### ê³¼ì œ 1: ê¸°ë³¸ ë™ì‘ ë§ˆìŠ¤í„° â­

**ëª©í‘œ**: ëª¨ë“  ì œì–´ í‚¤ë¥¼ ì‚¬ìš©í•´ë³´ê¸°

**ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] ë² ì´ìŠ¤ ì „ì§„/í›„ì§„ (Home/End)
- [ ] ë² ì´ìŠ¤ ì¢Œìš° ì´ë™ (Delete/PgDown)
- [ ] ë² ì´ìŠ¤ íšŒì „ (Insert/PgUp)
- [ ] ì™¼íŒ” 3ê´€ì ˆ ì›€ì§ì„ (Q/A, W/S, E/D)
- [ ] ì˜¤ë¥¸íŒ” 3ê´€ì ˆ ì›€ì§ì„ (U/J, I/K, O/L)

**ì„±ê³µ ê¸°ì¤€**: ê° í‚¤ì˜ ë™ì‘ì„ ì •í™•íˆ ì„¤ëª…í•  ìˆ˜ ìˆìŒ

---

### ê³¼ì œ 2: ê²½ë¡œ ì¶”ì¢… â­â­

**ëª©í‘œ**: ë² ì´ìŠ¤ë¥¼ ì‚¬ê°í˜• ê²½ë¡œë¡œ ì´ë™

**ì ˆì°¨**:
1. ì‹œì‘ ìœ„ì¹˜ ìŠ¤í¬ë¦°ìƒ·
2. ì •ì‚¬ê°í˜• (í•œ ë³€ = 5ì´ˆ ì´ë™) ê·¸ë¦¬ê¸°
3. ì¢…ë£Œ ìœ„ì¹˜ê°€ ì‹œì‘ ìœ„ì¹˜ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸

**íŒíŠ¸**: ê° ë³€ë§ˆë‹¤ ê°™ì€ ì‹œê°„ ë™ì•ˆ í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.

---

### ê³¼ì œ 3: ì–‘íŒ” ë™ê¸°í™” â­â­â­

**ëª©í‘œ**: ì–‘íŒ”ì„ ëŒ€ì¹­ìœ¼ë¡œ ì›€ì§ì´ê¸°

**ì ˆì°¨**:
1. ì–‘íŒ”ì„ ì´ˆê¸° ìì„¸ë¡œ (ëª¨ë“  ê´€ì ˆ 0)
2. Q + U ë™ì‹œ ëˆ„ë¦„ (ì–‘ìª½ ê´€ì ˆ 1)
3. W + I ë™ì‹œ ëˆ„ë¦„ (ì–‘ìª½ ê´€ì ˆ 2)
4. E + O ë™ì‹œ ëˆ„ë¦„ (ì–‘ìª½ ê´€ì ˆ 3)
5. í™”ë©´ì—ì„œ `Left Arm`ê³¼ `Right Arm` ê°’ ë¹„êµ

**ì„±ê³µ ê¸°ì¤€**: 
```
Left Arm:  [0.03, 0.02, 0.05]
Right Arm: [0.03, 0.02, 0.05]  â† ì™„ì „íˆ ë™ì¼!
```

---

### ê³¼ì œ 4: ì½”ë“œ ìˆ˜ì • - ìŠ¤í… í¬ê¸° ì¡°ì • â­â­â­â­

**ëª©í‘œ**: `arm_step`ì„ ìˆ˜ì •í•´ì„œ ë” ë¹ ë¥¸ ì›€ì§ì„ ë§Œë“¤ê¸°

**ì ˆì°¨**:
1. `xlerobot_mujoco.py` íŒŒì¼ ì—´ê¸°
2. 156ë²ˆì§¸ ì¤„ ì°¾ê¸°:
   ```python
   arm_step = 0.005  # í˜„ì¬ ê°’
   ```
3. `0.01`ë¡œ ë³€ê²½ (2ë°° ë¹ ë¥´ê²Œ)
4. ì €ì¥ í›„ ì¬ì‹¤í–‰
5. Q í‚¤ ëˆŒë €ì„ ë•Œ ì›€ì§ì„ ì†ë„ ë¹„êµ

**ì§ˆë¬¸**:
- ë„ˆë¬´ í° ê°’ (ì˜ˆ: 0.1)ì„ ì‚¬ìš©í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?
- ì–´ë–¤ ê°’ì´ ê°€ì¥ ìì—°ìŠ¤ëŸ¬ìš´ê°€ìš”?

---

### ê³¼ì œ 5: ìƒˆ í‚¤ ì¶”ê°€ - ë¦¬ì…‹ ê¸°ëŠ¥ â­â­â­â­â­

**ëª©í‘œ**: `R` í‚¤ë¡œ ëª¨ë“  ê´€ì ˆì„ ì´ˆê¸° ìœ„ì¹˜ë¡œ ë˜ëŒë¦¬ê¸°

**ì ˆì°¨**:

1. **`__init__` ë©”ì„œë“œì— ì´ˆê¸° ìœ„ì¹˜ ì €ì¥**:
   ```python
   # ì•½ 40ë²ˆì§¸ ì¤„ ê·¼ì²˜ì— ì¶”ê°€
   self.initial_qCmd = self.qCmd.copy()
   ```

2. **`update_keyboards`ì— R í‚¤ ì¶”ê°€**:
   ```python
   # ì•½ 95ë²ˆì§¸ ì¤„ ê·¼ì²˜ì— ì¶”ê°€
   self.key_states["r"] = glfw.get_key(
       self.viewer.window, glfw.KEY_R
   ) == glfw.PRESS
   ```

3. **`update_reference`ì— ë¦¬ì…‹ ë¡œì§ ì¶”ê°€**:
   ```python
   # ì•½ 190ë²ˆì§¸ ì¤„ (ì™¼íŒ” ì œì–´ ì´í›„) ì¶”ê°€
   # Reset functionality
   if self.key_states["r"]:
       self.qCmd[:] = self.initial_qCmd.copy()
       print("Reset to initial position!")
   ```

4. **í…ŒìŠ¤íŠ¸**:
   - Q/W/Eë¡œ ì™¼íŒ” ì›€ì§ì´ê¸°
   - `R` í‚¤ ëˆ„ë¥´ê¸°
   - íŒ”ì´ ì´ˆê¸° ìœ„ì¹˜ë¡œ ëŒì•„ê°€ëŠ”ì§€ í™•ì¸

**ì„±ê³µ ê¸°ì¤€**: R í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì½˜ì†”ì— "Reset to initial position!" ì¶œë ¥ë˜ê³  ë¡œë´‡ì´ ì´ˆê¸° ìì„¸ë¡œ ë³µê·€

---

## ìš”ì•½

### í•µì‹¬ ê°œë…

1. **3ê°œ ì œì–´ ê·¸ë£¹**: ë² ì´ìŠ¤(6í‚¤) + ì™¼íŒ”(6í‚¤) + ì˜¤ë¥¸íŒ”(6í‚¤)
2. **ì¦ë¶„ ì œì–´**: í‚¤ë¥¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ `+0.005 rad` ë˜ëŠ” `-0.005 rad`
3. **ì‹¤ì‹œê°„ í”¼ë“œë°±**: í™”ë©´ í•˜ë‹¨ì— í˜„ì¬ ìƒíƒœ í‘œì‹œ
4. **60Hz ë Œë”ë§**: ë¶€ë“œëŸ¬ìš´ ì‹œê°í™”

### ì œì–´ íë¦„

```
í‚¤ë³´ë“œ ì…ë ¥ â†’ key_states ì—…ë°ì´íŠ¸ 
            â†’ ì œì–´ ëª…ë ¹ ê³„ì‚° (qCmd, qdCmd)
            â†’ MuJoCo actuatorì— ì „ë‹¬
            â†’ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜
            â†’ í™”ë©´ ë Œë”ë§
```

### ë‹¤ìŒ ë‹¨ê³„

- [3.4 Isaac Sim ì„¤ì • â†’](https://github.com/dinnerandcoffee/xlerobot-learning-guide/blob/main/learning_guide/03_simulation/04_isaac_sim.md): ì‚¬ì‹¤ì ì¸ ë Œë”ë§
- [3.5 ManiSkill í™˜ê²½ â†’](https://github.com/dinnerandcoffee/xlerobot-learning-guide/blob/main/learning_guide/03_simulation/05_maniskill.md): ê°•í™”í•™ìŠµ í›ˆë ¨
- [3.6 URDF/MJCF ëª¨ë¸ â†’](https://github.com/dinnerandcoffee/xlerobot-learning-guide/blob/main/learning_guide/03_simulation/06_robot_models.md): ë¡œë´‡ ëª¨ë¸ ì´í•´

---

[â† 3.2 MuJoCo ì„¤ì •](https://github.com/dinnerandcoffee/xlerobot-learning-guide/blob/main/learning_guide/03_simulation/02_mujoco_setup.md) | [3ì¥ ëª©ì°¨](https://github.com/dinnerandcoffee/xlerobot-learning-guide/blob/main/learning_guide/03_simulation/README.md) | [ë‹¤ìŒ: 3.4 Isaac Sim â†’](https://github.com/dinnerandcoffee/xlerobot-learning-guide/blob/main/learning_guide/03_simulation/04_isaac_sim.md)
